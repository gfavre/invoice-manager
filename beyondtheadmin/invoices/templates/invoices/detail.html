{% load i18n switzerland fullurl %}
<!DOCTYPE html>
<html lang="{{ invoice.client.language }}">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>{% block title %}
    {% if not invoice.is_draft %}{{ invoice.code }} - {{ invoice.company.name }}{% else %}{% trans "Preview" %}
    {% endif %}{% endblock title %}
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
  <!--[if lt IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
  <![endif]-->

  {% block css %}
    <!-- Use bootstrap for scaffolding -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;500&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: Roboto, "Helvetica Neue", Helvetica, Arial, sans-serif;
        font-size: 11pt;
        font-weight: 300;
        position: relative;

      }

      .invoice {
        margin-top: 17mm;
        margin-left: auto;
        margin-right: auto;
        margin-bottom: 17mm;
      }

      .invoice a:link, .invoice a:visited, .invoice a:hover, .invoice a:active {
        color: {{ invoice.company.contrast_color }};
      }

      .invoice h1 {
        font-size: 36pt;
        font-weight: 100;
        margin-top: 5.5cm;
      }

      .invoice h3 {
        font-size: 14pt;
        font-weight: 500;
      }

      .invoice dt, th {
        font-weight: 400;
      }

      .invoice .table {
        font-family: Roboto, "Helvetica Neue", Helvetica, Arial, sans-serif;
        font-size: 11pt;
        font-weight: 300;
        width: 100%;
      }

      .invoice .table th {
        background-color: {{ invoice.company.contrast_color }};
        color: white;
        border-right: 0.5px solid white;
        padding: 4pt;
        line-height: 12pt;
      }

      .invoice .table td {
        padding: 4pt;
        line-height: 12pt;
      }

      .invoice .table thead th {
        text-align: center;
      }

      .invoice .table td:first-child {
        text-align: left;
      }

      .invoice .table td, table tfoot th {
        text-align: right;
      }

      .invoice .table tbody tr:nth-child(even) {
        background-color: #f2f2f2;
      }

      .invoice tfoot tr:first-child td {
        border-top: 1px solid{{ invoice.company.contrast_color }};
      }

      #company-address {
        position: absolute;
        top: 12.75cm;
        font-size: 10pt;
      }

      #logo img {
        height: 2.5cm;
      }

      #customer-address {
        margin-top: 3.5cm;
        height: 5cm;
      }

      #customer-address address {
        margin-bottom: 5rem;
      }

      #invoice-content {
        margin-top: 0.7cm;
      }

      #bank {
        margin-bottom: 1cm;
      }

      #signature {
        margin-top: 1cm;
        margin-bottom: 2cm;
      }

      #signature-image {
        width: 5cm;
      }

      #qrbill, #qrbill svg {
        width: 100%;
        padding: 0;
      }

      .invoice abbr[title] {
        border-bottom: none !important;
        cursor: inherit !important;
        text-decoration: none !important;
      }

      section {
        width: 100%;
      }

      @media print {
        @page {
          size: 210mm 297mm;
          margin: 10mm 10mm 0mm 10mm;
        }

        .invoice {
          width: 210mm;
          margin-top: 10mm;
        }

        a:not(.btn) {
          text-decoration: none;
          color: #000;
        }

        .invoice .table th {
          background-color: {{ invoice.company.contrast_color }} !important;
          color: #fff;
        }

        #invoice-content .table td {
          padding-right: 15px;
        }

        #qrbill svg {
          padding: 0;
          margin-top: 17mm;
          height: auto !important;
          position: absolute;
          bottom: 0;
        }

        #qrbill {
          margin-top: 17mm;
          page-break-inside: avoid;
          bottom: 10px;
          position: static;
          min-height: 136vh;
        }
      }
    </style>
  {% endblock css %}

</head>

<body>
{% block navigation %}
  <nav class="navbar navbar-expand-lg navbar-light bg-dark d-print-none">
    <div class="container-fluid">
      {% if invoice.is_ready %}
        <button class="btn btn-lg btn-primary " id="download-button">
          <span class="label"><i class="bi bi-file-earmark-text"></i>&nbsp; {% trans "Download" %}</span>
          <span class="loading d-none">
          <div class="spinner-border spinner-border-sm" role="status"></div>
          {% trans "Generating PDF..." %}
        </span>
          <span class="error d-none">
          <i class="bi bi-exclamation-triangle"></i>&nbsp; {% trans "Error" %}
        </span>
        </button>
      {% endif %}

      {% if user.is_authenticated %}
        {% if invoice.is_draft and invoice.is_ready %}
          <span>
            <a class="btn btn-lg btn-success" href="{{ invoice.get_send_url }}">
              <i class="bi bi-box-arrow-right"></i>&nbsp; {% trans "Send" %}
            </a>
            <a class="btn btn-lg btn-success" href="{{ invoice.get_snail_mail_url }}">
              <i class="bi bi-mailbox"></i>&nbsp; {% trans "Mark as sent" %}
            </a>
          </span>
        {% endif %}

        <a class="btn btn-lg btn-secondary" href="{{ invoice.get_edit_url }}">
          <i class="bi bi-pencil"></i>&nbsp; {% trans "Edit" %}
        </a>
      {% endif %}
    </div>

  </nav>

{% endblock %}
{% if messages %}
          {% for message in messages %}
            <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %} d-print-none">{{ message }}
              <button type="button" class="close" data-dismiss="alert" aria-label="{% trans "Close" %}"><span
                  aria-hidden="true">&times;</span></button>
            </div>
          {% endfor %}
        {% endif %}
<div class="container invoice">
  <div class="row">
    <div class="col-3" id="side">
      <h1>{% trans "Invoice" %}</h1>
      <div itemscope itemtype="http://schema.org/LocalBusiness" id="company-address">
        <span itemprop="name">{{ invoice.company.name|linebreaksbr }}</span> <br>

        <address itemprop="address" itemscope="" itemtype="http://schema.org/PostalAddress">
          <span itemprop="streetAddress">{{ invoice.company.address }}</span><br>
          {% if invoice.display_country %}
            <span itemprop="addressCountry">{{ invoice.company.country.code }}</span>-{% endif %}<span
          itemprop="postalCode">{{ invoice.company.zip_code }}</span> <span
          itemprop="addressLocality">{{ invoice.company.city }}</span><br>
        </address>
        {% if invoice.company.phone %}
          {% if not invoice.company.additional_phone %}<span>{% trans "Tel" %}</span>{% endif %}
          <a href="{{ invoice.company.phone|phone:'RFC3966' }}"
             itemprop="telephone">{{ invoice.company.phone|phone }}</a>
          <br>{% endif %}
        {% if invoice.company.additional_phone %}
          <a href="{{ invoice.company.additional_phone|phone:'RFC3966' }}"
             itemprop="telephone">{{ invoice.company.additional_phone|phone }}</a>
          <br>{% endif %}
        {% if invoice.company.email %}
          <a href="mailto:{{ invoice.company.email }}" itemprop="email">{{ invoice.company.email }}</a><br>{% endif %}
        {% if invoice.company.website_url %}
          <a href="{{ invoice.company.website_url }}">{{ invoice.company.website_url }}</a><br>{% endif %}
        {% if invoice.company.vat_id %}<span>{% trans "UID" %}:</span> <span itemprop="vatID">{{ invoice.company.vat_id }}</span>
          <br>{% endif %}
      </div>

    </div>
    <div class="col" id="content">
      <div class="row justify-content-end">
        {% if invoice.company.logo %}
          <section class="col-12 text-right" id="logo"><img src="{% buildfullurl invoice.company.logo.url %}"></section>
        {% endif %}
        <section class="col-6" id="customer-address">
          <address>
            {{ invoice.client.name }}<br>
            {{ invoice.client.address | linebreaksbr }}<br>
            {% if invoice.display_country %}{{ invoice.client.country.code }} - {% endif %}{{ invoice.client.zip_code }} {{ invoice.client.city }}
          </address>
          <p>{% blocktrans with place=invoice.company.city date=invoice.displayed_date|swiss_date %}{{ place }},
            {{ date }}{% endblocktrans %}</p>
        </section>
      </div>
      <section id="invoice-content">
        <h3>{{ invoice.title }}</h3>
        <p>{{ invoice.description|safe }}</p>
        {% if invoice.period_start and invoice.period_end %}
          <p>{% blocktrans with start=invoice.period_start|swiss_date end=invoice.period_end|swiss_date %}Work done between
            {{ start }} and {{ end }}{% endblocktrans %}</p>
        {% endif %}
        <dl class="row">
          <dt class="col-3">{% trans "Invoice ID" %}</dt>
          <dd class="col-9">
            {% if invoice.code %}{{ invoice.code }}{% else %}{{ invoice.client.slug }}-xxx{% endif %}</dd>
          <dt class="col-3">{% trans "Due date" %}</dt>
          <dd class="col-9">{{ invoice.due_date | swiss_date }}</dd>

        </dl>
        <table class="table">
          <thead>
          <tr>
            <th>{% trans "Description" %}</th>
            <th>{% trans "Quantity" %}</th>
            <th>{% trans "Unit" %}</th>
            <th>{% trans "Unit price" %}</th>
            <th>{% trans "Cost" %}</th>
          </tr>
          </thead>
          <tbody>
          {% for line in invoice.lines.all %}
            <tr>
              <td>{{ line.description }}</td>
              <td class="text-nowrap">
                {% if line.is_hours %}{{ line.quantity|timedelta }}{% else %}{{ line.quantity }}{% endif %}</td>
              <td class="text-nowrap">{{ line.get_unit_display }}</td>
              <td class="text-nowrap">{{ line.price_per_unit|money_html }}</td>
              <td class="text-nowrap">{{ line.total|money_html }}</td>
            </tr>
          {% endfor %}
          </tbody>
          <tfoot>
          {% if invoice.vat_rate %}
          <tr>
            <td colspan="4" class="text-right">{% trans "Subtotal" %}</td>
            <td class="text-nowrap">{{ invoice.subtotal|money_html }}</td>
          </tr>
          <tr>
            <td colspan="3" class="text-right">{% trans "VAT" %}</td>
            <td class="text-nowrap">{{ invoice.vat_rate|percentage }}</td>
            <td class="text-nowrap">{{ invoice.get_vat|money_html }}</td>
          </tr>
          {% endif %}
          <tr>
            <th colspan="4" class="text-right">{% trans "Total" %}</th>
            <th class="text-nowrap">{{ invoice.get_total|money_html }}</th>
          </tr>
          </tfoot>
        </table>
      </section>
      {% if invoice.company.iban %}
        <section class="row" id="bank">
          <div class="col-6">
            {% trans "Bank details" %}
          </div>
          <div class="col-6">
            {{ invoice.company.bank_account_name }}, {{ invoice.company.zip_code }} {{ invoice.company.city }}<br>
            {% if invoice.company.bank %}{{ invoice.company.bank }}<br>{% endif %}
            {% if invoice.company.bic %}BIC: {{ invoice.company.bic }}<br>{% endif %}
            {{ invoice.company.iban|iban }}
          </div>
        </section>
      {% endif %}
      {% if invoice.company.invoice_note %}
        <section class="mb-4">{{ invoice.company.invoice_note|safe }}</section>
      {% endif %}
      <section class="row">
        <div class="{% if invoice.company.has_signature %}col-6{% else %}col{% endif %}">
          {% if invoice.company.thanks %}{{ invoice.company.thanks }}{% else %}
            {% trans "Thank you for your continued confidence." %}{% endif %}
        </div>
        {% if invoice.company.has_signature %}
          <div class="col-6" id="signature">
            {% if invoice.company.signature_image %}
              <img src="{% buildfullurl invoice.company.signature_image.url %}" id="signature-image">
            {% endif %}
            {% if invoice.company.signature_text %}
              <p>{{ invoice.company.signature_text }}</p>
            {% endif %}
          </div>
        {% endif %}
      </section>
    </div>
  </div>
</div>

{% if invoice.qr_bill %}
  <section id="qrbill" class="container-fluid">
    {{ invoice.qr_bill|safe }}
  </section>
{% endif %}


{% block js %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script>
    $(document).ready(function () {

      let refresh = function () {
        $('#qrbill').html('<img src="{% buildfullurl invoice.get_qrbill_url %}" style="width:100%">');
      };


      $('body').on('click', '#download-button:not(.btn-danger)', function (event) {
        event.preventDefault();
        function doPoll() {
          const url = "{{ invoice.get_pdf_generation_url }}";
          $('#download-button .label').addClass('d-none');
          $('#download-button .loading').removeClass('d-none');
          $.get(url).done(function (data) {
            if (data.status === 'ready') {
              const a = document.createElement('a');
              document.body.appendChild(a);
              a.style = 'display: none';
              a.href = data.pdf;
              a.download = ''
              a.click();
              $('#download-button .label').removeClass('d-none');
              $('#download-button .loading').addClass('d-none');
            } else if (data.status === 'error') {
              $('#download-button .loading').addClass('d-none');
              $('#download-button .error').removeClass('d-none');
              $('#download-button').toggleClass(['btn-primary', 'btn-danger']);

            } else {
              setTimeout(doPoll, 500);
            }
          }).fail(function () {
            $('#download-button .loading').addClass('d-none');
            $('#download-button .error').removeClass('d-none');
            $('#download-button').toggleClass(['btn-primary', 'btn-danger']);
          })
        }

        doPoll()
      });

      //$(this).attr('href', '{% buildfullurl invoice.get_pdf_generation_url %}');
    });
  </script>
{% endblock %}

</body>
</html>
